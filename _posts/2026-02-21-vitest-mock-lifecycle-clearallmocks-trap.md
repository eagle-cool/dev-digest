---
title: "Vitest 4 Mock ç”Ÿå‘½é€±æœŸå®Œå…¨è§£æï¼šclearAllMocks çš„é™·é˜±ï¼Œä»¥åŠä½ çœŸæ­£è©²ç”¨çš„æ–¹æ³•"
date: 2026-02-21
description: "æ·±å…¥å‰–æ Vitest 4 çš„ mock ä¸‰å…„å¼Ÿ â€” clearAllMocksã€resetAllMocksã€restoreAllMocks çš„è¡Œç‚ºå·®ç•°ã€‚å¾ä¸€å€‹ mockResolvedValueOnce æ®˜ç•™ queue å°è‡´çš„è©­ç•°æ¸¬è©¦å¤±æ•—èªªèµ·ï¼Œå¸¶ä½ ç†è§£ mock ç”Ÿå‘½é€±æœŸç®¡ç†çš„æ¯å€‹ç´°ç¯€ã€‚"
tags: [deep-dive, frontend, programming]
---

æœ€è¿‘çœ‹åˆ°ä¸€ç¯‡å¾ˆç²¾å½©çš„é™¤éŒ¯ç´€éŒ„ï¼šä¸€ä½å·¥ç¨‹å¸«åœ¨ 180 å€‹æ¸¬è©¦çš„æª”æ¡ˆè£¡ï¼Œæœ‰ 10 å€‹æ¸¬è©¦è«åå…¶å¦™åœ°å›å‚³ 200 è€Œä¸æ˜¯é æœŸçš„ 403ã€‚æ¯å€‹æ¸¬è©¦å–®ç¨è·‘éƒ½éï¼Œåˆåœ¨ä¸€èµ·å°±ç‚¸ã€‚èŠ±äº†åŠå¤©æ‰æ‰¾åˆ°å…ƒå…‡â€”â€”`vi.clearAllMocks()` æ ¹æœ¬æ²’æœ‰åšåˆ°ä½ ä»¥ç‚ºå®ƒåšçš„äº‹ã€‚

é€™ä¸æ˜¯ Vitest çš„ bugã€‚é€™æ˜¯ä¸€å€‹è¨­è¨ˆæ±ºç­–ã€‚è€Œé€™å€‹è¨­è¨ˆæ±ºç­–ï¼Œæ­£åœ¨é»˜é»˜åœ°å’¬è‘—æ¯ä¸€å€‹å¯« `beforeEach(() => vi.clearAllMocks())` å°±è¦ºå¾—å¤©ä¸‹å¤ªå¹³çš„å‰ç«¯å·¥ç¨‹å¸«ã€‚

---

## æ¡ˆç™¼ç¾å ´ï¼šç•¶ mock çš„å¹½éˆå›ä¾†æ‰¾ä½ 

å…ˆé‚„åŸä¸€ä¸‹å ´æ™¯ã€‚ä½ æœ‰ä¸€å€‹æ¸¬è©¦æª”æ¡ˆï¼Œè£¡é¢æœ‰å¥½å¹¾å€‹ `describe` å€å¡Šã€‚ç¬¬ä¸€çµ„æ¸¬è©¦æ˜¯ TDD é¢¨æ ¼çš„ã€Œå…ˆå¯«æ¸¬è©¦å†å¯¦ä½œè·¯ç”±ã€â€”â€”é€™äº›è·¯ç”±é‚„ä¸å­˜åœ¨ï¼Œæ‰€ä»¥è«‹æ±‚æ‰“éå»ç›´æ¥ 404ã€‚ä½†æ¸¬è©¦è£¡å·²ç¶“ç”¨ `mockResolvedValueOnce()` é å…ˆå¡å¥½äº† mock è³‡æ–™ï¼š

```javascript
// ç¬¬ä¸€çµ„æ¸¬è©¦ï¼šè·¯ç”±é‚„æ²’å¯¦ä½œï¼Œæœƒ 404
describe('upcoming user routes', () => {
  it('should return user profile', async () => {
    mockStorage.getProfile.mockResolvedValueOnce({
      id: 'user-123',
      role: 'admin'
    });
    const res = await request(app).get('/api/users/123');
    expect(res.status).toBe(200); // å¯¦éš›æ‹¿åˆ° 404ï¼Œæ¸¬è©¦ failï¼ˆé æœŸè¡Œç‚ºï¼‰
  });
});
```

è·¯ç”± 404 äº†ï¼Œmock function æ ¹æœ¬æ²’è¢«å‘¼å«ã€‚é‚£å€‹ `mockResolvedValueOnce` å¡é€²å»çš„å€¼å°±é€™æ¨£å®‰éœåœ°èººåœ¨ queue è£¡ï¼Œç­‰è‘—è¢«æ¶ˆè²»ã€‚

ç¬¬äºŒçµ„æ¸¬è©¦è·‘èµ·ä¾†ï¼Œ`beforeEach` è£¡ä¹–ä¹–åœ°å‘¼å«äº† `vi.clearAllMocks()`ã€‚çœ‹èµ·ä¾†ä¸€åˆ‡ä¹¾æ·¨äº†ï¼Œå°å§ï¼Ÿ

```javascript
describe('ownership check routes', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    mockStorage.getProfile.mockResolvedValue({
      id: 'user-456',
      role: 'viewer'
    });
  });

  it('should return 403 for non-owner', async () => {
    const res = await request(app).get('/api/projects/789');
    expect(res.status).toBe(403); // æœŸæœ› 403ï¼Œå»æ‹¿åˆ° 200 ğŸ˜±
  });
});
```

çµæœæ‹¿åˆ° 200ã€‚å› ç‚º mock å›å‚³çš„ä¸æ˜¯ `user-456`ï¼ˆviewerï¼‰ï¼Œè€Œæ˜¯ç¬¬ä¸€çµ„æ¸¬è©¦æ®˜ç•™åœ¨ queue è£¡çš„ `user-123`ï¼ˆadminï¼‰ã€‚admin ç•¶ç„¶é€šéäº† ownership checkã€‚

## clearAllMocks åˆ°åº•æ¸…äº†ä»€éº¼ï¼Ÿ

é€™å°±æ˜¯å•é¡Œçš„æ ¸å¿ƒã€‚`vi.clearAllMocks()` å‘¼å«çš„æ˜¯æ¯å€‹ spy ä¸Šçš„ `.mockClear()`ï¼Œè€Œ `mockClear` åªåšä¸€ä»¶äº‹ï¼š

- **æ¸…é™¤** `mock.calls`ï¼ˆå‘¼å«ç´€éŒ„ï¼‰
- **æ¸…é™¤** `mock.results`ï¼ˆå›å‚³çµæœç´€éŒ„ï¼‰
- **æ¸…é™¤** `mock.instances`ï¼ˆå¯¦ä¾‹ç´€éŒ„ï¼‰

å°±é€™æ¨£ã€‚å®ƒ**ä¸æœƒ**æ¸…é™¤ï¼š

- `mockResolvedValueOnce` / `mockReturnValueOnce` å¡é€²å»çš„ queue
- `mockImplementation` è¨­å®šçš„å¯¦ä½œ
- ä»»ä½•ã€Œonceã€ç³»åˆ—çš„å¾…æ¶ˆè²»å€¼

ç”¨ç™½è©±æ–‡èªªï¼š`clearAllMocks` æ¸…çš„æ˜¯ã€Œé€šè©±ç´€éŒ„ã€ï¼Œä¸æ˜¯ã€Œå¾…è¾¦äº‹é …ã€ã€‚ä½ çš„ mock é‚„è¨˜å¾—ä½ ä¹‹å‰è·Ÿå®ƒèªªã€Œä¸‹æ¬¡è¢«å‘¼å«çš„æ™‚å€™å›å‚³é€™å€‹å€¼ã€ï¼Œå®ƒåªæ˜¯å¿˜äº†ã€Œä¸Šæ¬¡æ˜¯èª°å‘¼å«äº†æˆ‘ã€ã€‚

é€™å€‹è¡Œç‚ºå¾ Jest æ™‚ä»£å°±æ˜¯é€™æ¨£ï¼ŒVitest å®Œæ•´ç¹¼æ‰¿äº†é€™å€‹è¨­è¨ˆã€‚Jest çš„ GitHub issue [#7136](https://github.com/jestjs/jest/issues/7136) åœ¨ 2018 å¹´å°±æœ‰äººæéï¼šã€Œ`clearAllMocks` é€™åå­—ä¹Ÿå¤ªèª¤å°äº†å§ï¼Ÿã€ã€‚Jest ç¶­è­·è€…çš„å›æ‡‰æ˜¯ï¼šã€Œé€™ä¸æ˜¯ bugï¼Œæ˜¯è¨­è¨ˆã€‚`clear` æŒ‡çš„æ˜¯æ¸…é™¤ mock ç‰©ä»¶çš„ä½¿ç”¨è³‡æ–™ï¼Œä¸æ˜¯æ¸…é™¤å¯¦ä½œã€‚ã€ç„¶å¾Œ issue å°±è¢«é—œäº†ã€‚

å…«å¹´å¾Œï¼ŒåŒæ¨£çš„å‘é‚„åœ¨å’¬äººã€‚

## Mock ä¸‰å…„å¼Ÿï¼šclearã€resetã€restore

Vitestï¼ˆå’Œ Jestï¼‰æä¾›äº†ä¸‰å€‹å±¤ç´šçš„ mock æ¸…ç†æ–¹æ³•ã€‚å®ƒå€‘çš„é—œä¿‚åƒæ˜¯ä¿„ç¾…æ–¯å¥—å¨ƒï¼š

### mockClear() / vi.clearAllMocks()

æœ€è¼•é‡çš„æ¸…ç†ã€‚åªæ¸…é™¤å‘¼å«æ­·å²ã€‚

```javascript
const fn = vi.fn().mockReturnValue('hello');
fn(); // è¢«å‘¼å«ä¸€æ¬¡

fn.mockClear();

console.log(fn.mock.calls.length); // 0 â€” å‘¼å«ç´€éŒ„æ¸…äº†
console.log(fn());                  // 'hello' â€” å¯¦ä½œé‚„åœ¨
```

**é©ç”¨å ´æ™¯**ï¼šä½ æƒ³åœ¨åŒä¸€å€‹æ¸¬è©¦è£¡å¤šæ¬¡æ–·è¨€å‘¼å«ç´€éŒ„ï¼Œä¸­é–“æ¸…ä¸€ä¸‹ã€‚Mock è¡Œç‚ºä¿æŒä¸è®Šã€‚

### mockReset() / vi.resetAllMocks()

ä¸­é‡æ¸…ç†ã€‚æ¸…é™¤å‘¼å«æ­·å² **åŠ ä¸Š** é‡ç½®æ‰€æœ‰å¯¦ä½œï¼ŒåŒ…å« `once` queueã€‚

```javascript
const fn = vi.fn().mockReturnValue('hello');
fn.mockReturnValueOnce('first call only');

fn.mockReset();

console.log(fn());           // undefined â€” å¯¦ä½œè¢«æ¸…äº†
console.log(fn.mock.calls);  // æœ‰ç´€éŒ„ï¼ˆå› ç‚ºå‰›å‘¼å«äº†ä¸€æ¬¡ï¼‰
```

æ³¨æ„ä¸€å€‹ Vitest å’Œ Jest çš„å·®ç•°ï¼šåœ¨ Vitest è£¡ï¼Œå¦‚æœä½ çš„ mock æ˜¯ç”¨ `vi.fn(impl)` å»ºç«‹çš„ï¼Œ`mockReset()` æœƒ**é‚„åŸåˆ°åŸå§‹ impl**ï¼Œè€Œä¸æ˜¯è®Šæˆç©ºå‡½å¼ã€‚Jest å‰‡æ˜¯ä¸€å¾‹è®Šæˆå›å‚³ `undefined` çš„ç©ºå‡½å¼ã€‚é€™æ˜¯ Vitest åˆ»æ„çš„è¨­è¨ˆå·®ç•°ï¼Œä¹Ÿæ˜¯å®ƒåœ¨ v3 çš„ migration guide è£¡ç‰¹åˆ¥æ¨™æ³¨çš„ã€‚

**é©ç”¨å ´æ™¯**ï¼š`beforeEach` è£¡çš„å…¨åŸŸæ¸…ç†ã€‚ç¢ºä¿æ¯å€‹æ¸¬è©¦å¾å®Œå…¨ä¹¾æ·¨çš„ç‹€æ…‹é–‹å§‹ã€‚

### mockRestore() / vi.restoreAllMocks()

æœ€é‡é‡ç´šçš„æ¸…ç†ã€‚åš `mockReset` çš„æ‰€æœ‰äº‹ï¼Œå†åŠ ä¸Š**é‚„åŸè¢« spy çš„åŸå§‹å‡½å¼**ã€‚

```javascript
const obj = { greet: () => 'real' };
vi.spyOn(obj, 'greet').mockReturnValue('mocked');

console.log(obj.greet()); // 'mocked'

obj.greet.mockRestore();

console.log(obj.greet()); // 'real' â€” åŸå§‹å¯¦ä½œå›ä¾†äº†
```

ä½† Vitest 4 åœ¨é€™è£¡æœ‰ä¸€å€‹é‡å¤§çš„ breaking changeï¼š**`vi.restoreAllMocks()` ä¸å†å½±éŸ¿ automock**ï¼Œåªå°æ‰‹å‹•ç”¨ `vi.spyOn` å»ºç«‹çš„ spy æœ‰æ•ˆã€‚å¦‚æœä½ çš„æ¸¬è©¦å¤§é‡ä¾è³´ `vi.mock()` è‡ªå‹• mock æ¨¡çµ„ï¼Œç„¶å¾Œåœ¨ `afterAll` è£¡ç”¨ `vi.restoreAllMocks()` æ¸…ç†â€”â€”å‡ç´šåˆ° Vitest 4 ä¹‹å¾Œï¼Œé‚£äº› automock ä¸æœƒè¢«é‚„åŸã€‚

**é©ç”¨å ´æ™¯**ï¼š`afterAll` è£¡çš„çµ‚æ¥µæ¸…ç†ï¼Œç¢ºä¿ä¸€å€‹æ¸¬è©¦æª”æ¡ˆä¸æœƒå½±éŸ¿ä¸‹ä¸€å€‹ã€‚

### ä¸€å¼µè¡¨ææ‡‚

| å‹•ä½œ | mockClear | mockReset | mockRestore |
|------|-----------|-----------|-------------|
| æ¸…é™¤ `mock.calls` | âœ… | âœ… | âœ… |
| æ¸…é™¤ `mock.results` | âœ… | âœ… | âœ… |
| æ¸…é™¤ `once` queue | âŒ | âœ… | âœ… |
| é‡ç½® implementation | âŒ | âœ… | âœ… |
| é‚„åŸåŸå§‹å‡½å¼ï¼ˆspyOnï¼‰ | âŒ | âŒ | âœ… |

## ç‚ºä»€éº¼é€™å€‹é™·é˜±ç‰¹åˆ¥ç‹ 

ä½ å¯èƒ½è¦ºå¾—ï¼šã€ŒOK æˆ‘çŸ¥é“äº†ï¼Œä»¥å¾Œç”¨ `resetAllMocks` å°±å¥½ã€‚ã€æ²’é€™éº¼å–®ç´”ã€‚

### é™·é˜±ä¸€ï¼š`clearAllMocks` æ˜¯å„è™•æ¨è–¦çš„ã€Œæœ€ä½³å¯¦è¸ã€

ä¸å°‘æ•™å­¸æ–‡ç« å’Œ style guide æœƒæ¨è–¦åœ¨ `beforeEach` è£¡ç”¨ `vi.clearAllMocks()`ã€‚ç†ç”±è½èµ·ä¾†å¾ˆåˆç†ï¼šä½ åªæƒ³æ¸…é€šè©±ç´€éŒ„ï¼Œä¿ç•™ mock è¡Œç‚ºï¼Œé€™æ¨£ä¸ç”¨æ¯å€‹æ¸¬è©¦éƒ½é‡æ–°è¨­å®š mockã€‚çœäº‹ï¼Œå„ªé›…ã€‚

å•é¡Œæ˜¯ï¼Œé€™å€‹å»ºè­°éš±å«äº†ä¸€å€‹å‰æï¼š**ä½ çš„æ¯å€‹ `mockResolvedValueOnce` éƒ½æœƒè¢«æ¶ˆè²»æ‰**ã€‚ä¸€æ—¦æœ‰æ¸¬è©¦ææ—©çµæŸï¼ˆerrorã€early returnã€è·¯ç”±ä¸å­˜åœ¨ï¼‰ï¼Œqueue è£¡å°±æœƒæ®˜ç•™å€¼ã€‚è€Œ `clearAllMocks` å°é€™äº›æ®˜ç•™å€¼è¦–è€Œä¸è¦‹ã€‚

### é™·é˜±äºŒï¼šæ¸¬è©¦é †åºä¾è³´

é€™é¡ bug çš„æœ€æƒ¡æ¯’ä¹‹è™•åœ¨æ–¼å®ƒ**ä¾è³´æ¸¬è©¦åŸ·è¡Œé †åº**ã€‚å–®ç¨è·‘ä»»ä½•ä¸€å€‹ `describe` å€å¡Šéƒ½æ²’å•é¡Œã€‚åªæœ‰ç‰¹å®šçš„åŸ·è¡Œé †åºæ‰æœƒè§¸ç™¼ã€‚è€Œ Vitest é è¨­æ˜¯æŒ‰æª”æ¡ˆå…§çš„å®£å‘Šé †åºè·‘æ¸¬è©¦ï¼Œæ‰€ä»¥é€™å€‹é †åºæ˜¯ç©©å®šçš„â€”â€”æ„å‘³è‘—å®ƒä¸æ˜¯ã€Œå¶çˆ¾å¤±æ•—ã€ï¼Œè€Œæ˜¯ã€Œç©©å®šåœ°åœ¨ CI è£¡å¤±æ•—ä½†ä½ ä¸çŸ¥é“ç‚ºä»€éº¼ã€ã€‚

å¦‚æœä½ é–‹äº† `--sequence.shuffle`ï¼ˆéš¨æ©Ÿæ’åºæ¸¬è©¦ï¼‰ï¼Œé€™ç¨®å•é¡Œåè€Œæ›´å®¹æ˜“æµ®ç¾ï¼Œå› ç‚ºä¸åŒçš„åŸ·è¡Œé †åºæœƒè®“ä¸åŒçš„æ¸¬è©¦å¤±æ•—ã€‚

### é™·é˜±ä¸‰ï¼šå‘½åèª¤å°æ˜¯è·¨æ¡†æ¶çš„å…±æ¥­

é€™ä¸æ˜¯ Vitest ç¨æœ‰çš„å•é¡Œã€‚Jest ä¹Ÿä¸€æ¨£ã€‚Jest issue [#7136](https://github.com/jestjs/jest/issues/7136) è£¡æœ‰ä¸€ä¸²ç•™è¨€éƒ½åœ¨åæ§½å‘½åï¼šã€Œ`clear` é€™å€‹å­—è®“äººè¦ºå¾—æ˜¯ã€æ¸…ç©ºä¸€åˆ‡ã€ï¼Œä½†å¯¦éš›ä¸Šå®ƒåªæ˜¯ã€æ¸…é™¤æ­·å²ç´€éŒ„ã€ã€‚ã€æœ‰äººå»ºè­°æ”¹åå« `resetMockState` æˆ– `clearMockUsageData`ï¼Œä½†ç¶­è­·è€…æ²’æœ‰æ¡ç´ã€‚

Vitest ç¹¼æ‰¿äº† Jest çš„ API è¨­è¨ˆï¼ˆé€™æ˜¯åˆ»æ„çš„ï¼Œç‚ºäº†é™ä½é·ç§»æˆæœ¬ï¼‰ï¼Œè‡ªç„¶ä¹Ÿç¹¼æ‰¿äº†é€™å€‹èªç¾©é™·é˜±ã€‚

## Vitest 4 çš„ Mock è®Šé©

æ—¢ç„¶èŠåˆ°äº† mock è¡Œç‚ºï¼Œå€¼å¾—ä¸€æ Vitest 4ï¼ˆ2025 å¹´ 10 æœˆç™¼å¸ƒï¼‰åœ¨ mock æ©Ÿåˆ¶ä¸Šåšäº†å¹¾å€‹å€¼å¾—æ³¨æ„çš„æ”¹å‹•ï¼š

**restoreAllMocks è¡Œç‚ºæ”¶çª„**ï¼šå¦‚å‰æ‰€è¿°ï¼Œ`vi.restoreAllMocks()` ä¸å†å½±éŸ¿ automockã€‚config è£¡çš„ `restoreMocks: true` ä¹Ÿä¸€æ¨£ã€‚é€™å°é‚£äº›åœ¨å…¨åŸŸ setup è£¡ä¾è³´é€™å€‹è¨­å®šçš„å°ˆæ¡ˆä¾†èªªæ˜¯å€‹ breaking changeã€‚

**mockReset é‚„åŸè¡Œç‚ºä¿®æ­£**ï¼š`vi.fn(impl).mockReset()` ç¾åœ¨æœƒæ­£ç¢ºåœ°é‚„åŸåˆ°åŸå§‹çš„ `impl`ï¼Œè€Œä¸æ˜¯ä¹‹å‰æŸäº›é‚Šç•Œæƒ…æ³ä¸‹å›å‚³éŒ¯èª¤çš„å¯¦ä½œã€‚

**automock å¯¦ä¾‹éš”é›¢**ï¼šautomock çš„ instance method ç¾åœ¨æ­£ç¢ºéš”é›¢äº†ï¼Œä½†å’Œ prototype å…±äº«ç‹€æ…‹ã€‚è¦†å¯« prototype çš„ mock å¯¦ä½œæœƒå½±éŸ¿æ‰€æœ‰ instanceâ€”â€”é™¤é instance æœ‰è‡ªå·±çš„è‡ªè¨‚ mockã€‚è€Œä¸” automock çš„æ–¹æ³•**ä¸èƒ½å†è¢« `.mockRestore()` é‚„åŸ**ã€‚

**invocationCallOrder å¾ 1 é–‹å§‹**ï¼šå’Œ Jest å°é½Šï¼Œä¸å†å¾ 0 é–‹å§‹ã€‚å¦‚æœä½ çš„æ–·è¨€è£¡æœ‰ç”¨åˆ°é€™å€‹ï¼Œå‡ç´šå¾Œæœƒ breakã€‚

é€™äº›æ”¹å‹•æ•´é«”çš„æ–¹å‘æ˜¯ï¼šè®“ mock è¡Œç‚ºæ›´å¯é æ¸¬ã€æ›´æ˜ç¢ºï¼Œæ¸›å°‘éš±å¼çš„å‰¯ä½œç”¨ã€‚ä½† `clearAllMocks` ä¸æ¸… `once` queue é€™å€‹è¨­è¨ˆï¼Œä¾ç„¶æ²’æœ‰æ”¹è®Šã€‚

## æ¯é€± 3100 è¬æ¬¡ä¸‹è¼‰èƒŒå¾Œçš„æ¸¬è©¦å‚µ

Vitest ç›®å‰æ¯é€±è¶…é 3100 è¬æ¬¡ npm ä¸‹è¼‰ï¼Œæ ¹æ“š 2025 å¹´çš„ State of JavaScript èª¿æŸ¥å’Œç”¢æ¥­åˆ†æï¼Œè¶…é 80% çš„æ–°å°ˆæ¡ˆé¸æ“‡ Vitest è€Œé Jestã€‚Vitest å·²ç¶“ä¸æ˜¯ã€Œé‚£å€‹æ–°çš„æ¸¬è©¦æ¡†æ¶ã€â€”â€”å®ƒæ˜¯äº‹å¯¦ä¸Šçš„æ¨™æº–ã€‚

é€™ä»£è¡¨ä»€éº¼ï¼Ÿä»£è¡¨ `clearAllMocks` é€™å€‹é™·é˜±å½±éŸ¿çš„äººæ•¸ï¼Œæ¯”ä»¥å¾€ä»»ä½•æ™‚å€™éƒ½å¤šã€‚å¾ Jest é·ç§»éä¾†çš„åœ˜éšŠå¸¶è‘—èˆŠç¿’æ…£ï¼Œæ–°åŠ å…¥çš„é–‹ç™¼è€…è·Ÿè‘—æ•™å­¸æ–‡ç« å¯« `vi.clearAllMocks()`â€”â€”æ‰€æœ‰äººéƒ½åœ¨åŒä¸€å€‹å‘çš„é‚Šç·£ã€‚

æ›´å€¼å¾—æ“”å¿ƒçš„æ˜¯ Vitest 4 å¸¶ä¾†çš„ Browser Mode ç©©å®šç‰ˆã€‚ç•¶è¶Šä¾†è¶Šå¤šäººæŠŠæ¸¬è©¦å¾ JSDOM æ¬åˆ°çœŸå¯¦ç€è¦½å™¨ç’°å¢ƒï¼Œæ¸¬è©¦çš„è¤‡é›œåº¦æœƒé¡¯è‘—ä¸Šå‡ã€‚mock ç®¡ç†çš„æ¯ä¸€å€‹ç´°ç¯€éƒ½è®Šå¾—æ›´åŠ é—œéµï¼Œå› ç‚ºä½ ä¸å†æœ‰ JSDOM é‚£ç¨®ç›¸å°å¯¬å®¹çš„ç’°å¢ƒä¾†å…œåº•ã€‚

## å¯¦æˆ°å»ºè­°ï¼šä½ ç¾åœ¨è©²æ€éº¼åš

### 1. é è¨­ç”¨ `resetAllMocks`ï¼Œè€Œä¸æ˜¯ `clearAllMocks`

åœ¨ `vitest.config.ts` è£¡ç›´æ¥è¨­å®šï¼š

```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    mockReset: true,  // æ¯å€‹æ¸¬è©¦å‰è‡ªå‹• resetAllMocks
  },
});
```

æˆ–è€…åœ¨å€‹åˆ¥æ¸¬è©¦æª”æ¡ˆçš„ `beforeEach` è£¡ï¼š

```javascript
beforeEach(() => {
  vi.resetAllMocks();
});
```

æ˜¯çš„ï¼Œé€™ä»£è¡¨ä½ éœ€è¦åœ¨æ¯å€‹æ¸¬è©¦è£¡é‡æ–°è¨­å®š mock è¡Œç‚ºã€‚å¤šæ‰“å¹¾è¡Œç¨‹å¼ç¢¼ã€‚ä½†é€™å¹¾è¡Œç¨‹å¼ç¢¼ï¼Œèƒ½å¹«ä½ çœä¸‹ã€Œåœ¨ 180 å€‹æ¸¬è©¦è£¡ debug åŠå¤©æ‰¾ä¸åˆ°ç‚ºä»€éº¼ profile æ˜¯éŒ¯çš„ã€çš„æ™‚é–“ã€‚

### 2. å¦‚æœå …æŒç”¨ `clearAllMocks`ï¼Œå°é—œéµ mock å–®ç¨ `mockReset`

é€™æ˜¯åŸæ–‡ä½œè€…æ¡ç”¨çš„æ–¹æ¡ˆï¼š

```javascript
beforeEach(() => {
  vi.clearAllMocks();
  // å°å¯èƒ½æ®˜ç•™ once-queue çš„ mock ç‰¹åˆ¥è™•ç†
  mockStorage.getProfile.mockReset();
  mockStorage.getProfileCalendarToken.mockReset();
});
```

æŠ˜è¡·æ–¹æ¡ˆã€‚ä¿ç•™ `clearAllMocks` çš„æ–¹ä¾¿æ€§ï¼ˆä¸ç”¨é‡æ–°è¨­å®šæ‰€æœ‰ mockï¼‰ï¼Œä½†å°ã€Œé«˜é¢¨éšªã€mock åšé¡å¤–æ¸…ç†ã€‚å•é¡Œæ˜¯ä½ å¾—çŸ¥é“å“ªäº› mock æœ‰é¢¨éšªâ€”â€”è€Œé€™é€šå¸¸æ˜¯å‡ºäº‹ä¹‹å¾Œæ‰çŸ¥é“çš„ã€‚

### 3. é¿å…åœ¨ä¸ç¢ºå®šæœƒè¢«æ¶ˆè²»çš„æƒ…å¢ƒä½¿ç”¨ `mockResolvedValueOnce`

å¦‚æœä½ åœ¨å¯« TDD é¢¨æ ¼çš„ã€Œå…ˆå¯«æ¸¬è©¦ã€ï¼Œè¨˜ä½ï¼šå¦‚æœè·¯ç”±é‚„ä¸å­˜åœ¨ï¼Œmock å€¼ä¸æœƒè¢«æ¶ˆè²»ï¼Œå®ƒæœƒç•™åœ¨ queue è£¡ã€‚æ”¹ç”¨ `mockResolvedValue`ï¼ˆæ²’æœ‰ Onceï¼‰è¨­å®šé è¨­å€¼ï¼Œæˆ–ç¢ºä¿æ¸¬è©¦çš„ setup å’Œ teardown èƒ½è™•ç†æœªæ¶ˆè²»çš„ queueã€‚

### 4. é–‹å•Ÿ `--sequence.shuffle` åšç…™éœ§æ¸¬è©¦

```bash
vitest --sequence.shuffle
```

éš¨æ©Ÿæ‰“äº‚æ¸¬è©¦é †åºã€‚å¦‚æœä½ çš„æ¸¬è©¦å¥—ä»¶æœ‰ä»»ä½•éš±æ€§çš„é †åºä¾è³´â€”â€”ä¸ç®¡æ˜¯ mock queue æ®˜ç•™é‚„æ˜¯å…¶ä»–å…±äº«ç‹€æ…‹â€”â€”éš¨æ©ŸåŒ–æœƒæ›´å¿«åœ°æš´éœ²å‡ºä¾†ã€‚åœ¨ CI è£¡å¶çˆ¾è·‘ä¸€æ¬¡ï¼ˆæ¯”å¦‚æ¯é€±çš„ nightly buildï¼‰ï¼Œæ˜¯ç™¼ç¾é€™é¡å•é¡Œçš„å¥½æ–¹æ³•ã€‚

### 5. å–„ç”¨ Vitest 4 çš„ config é¸é …

Vitest æä¾›äº† config å±¤ç´šçš„ mock ç®¡ç†ï¼š

```typescript
export default defineConfig({
  test: {
    clearMocks: true,    // = beforeEach vi.clearAllMocks()
    mockReset: true,     // = beforeEach vi.resetAllMocks()
    restoreMocks: true,  // = beforeEach vi.restoreAllMocks()ï¼ˆv4 ä¸å« automockï¼‰
  },
});
```

é€™ä¸‰å€‹é¸é …æ˜¯äº’æ–¥çš„æ¦‚å¿µä½†å¯ä»¥åŒæ™‚é–‹ï¼ˆå¾Œè€…æœƒè¦†è“‹å‰è€…çš„è¡Œç‚ºï¼‰ã€‚å»ºè­°ï¼š**è‡³å°‘é–‹ `mockReset: true`**ã€‚

## å¯«åœ¨æœ€å¾Œ

mock ç®¡ç†è½èµ·ä¾†æ˜¯å€‹ç„¡èŠçš„è©±é¡Œã€‚ä¸‰å€‹ APIï¼Œä¸€å¼µæ¯”è¼ƒè¡¨ï¼Œå®Œäº‹ã€‚ä½†æ­£æ˜¯é€™ç¨®ã€Œçœ‹èµ·ä¾†å¾ˆç°¡å–®ã€çš„æ±è¥¿æœ€å®¹æ˜“å’¬äººã€‚å› ç‚ºä½ ä¸æœƒèŠ±æ™‚é–“å» double check ä¸€å€‹å«åš `clearAllMocks` çš„å‡½å¼æ˜¯ä¸æ˜¯çœŸçš„æ¸…äº†æ‰€æœ‰ mockâ€”â€”é€™åå­—å·²ç¶“å‘Šè¨´ä½ ç­”æ¡ˆäº†ï¼Œä¸æ˜¯å—ï¼Ÿ

åªæ˜¯ç­”æ¡ˆæ˜¯éŒ¯çš„ã€‚

å‰ç«¯æ¸¬è©¦çš„ä¸–ç•Œæ­£åœ¨å¿«é€Ÿè®ŠåŒ–ã€‚Vitest 4 å¸¶ä¾†äº†ç©©å®šçš„ Browser Modeã€visual regression testingã€Playwright trace æ”¯æ´ã€‚æ¸¬è©¦èƒ½åŠ›è¶Šä¾†è¶Šå¼·å¤§ï¼Œä½†åŸºç¤çš„ mock ç®¡ç†â€”â€”é€™å€‹å¾ Jest æ™‚ä»£å°±å­˜åœ¨çš„èªç¾©é™·é˜±â€”â€”ä¾ç„¶æ²’æœ‰è¢«ä¿®æ­£ã€‚

ä¸æ˜¯å› ç‚ºä¸èƒ½ä¿®ï¼Œè€Œæ˜¯å› ç‚ºä¿®äº†å°±æ˜¯ breaking changeï¼Œå½±éŸ¿å…¨ä¸–ç•Œæ¯é€± 3100 è¬æ¬¡ä¸‹è¼‰ã€‚æ‰€ä»¥å®ƒåªæœƒè¢«å¯«åœ¨æ–‡ä»¶çš„æŸå€‹è§’è½ï¼Œç„¶å¾Œç­‰è‘—ä¸‹ä¸€å€‹å€’æ¥£é¬¼èŠ±åŠå¤©å»ç™¼ç¾ã€‚

åˆ¥ç•¶é‚£å€‹å€’æ¥£é¬¼ã€‚å»ä½ çš„ `vitest.config.ts` è£¡ï¼ŒæŠŠ `mockReset` è¨­æˆ `true`ã€‚ç¾åœ¨å°±å»ã€‚

---

## å»¶ä¼¸é–±è®€

- [The Mock Queue Trap: A Vitest 4 Bug That Took Hours to Find](https://dev.to/ultron_cos/the-mock-queue-trap-a-vitest-4-bug-that-took-hours-to-find-33oi) â€” æœ¬æ–‡çš„èµ·é»ï¼Œä¸€ç¯‡ç²¾å½©çš„é™¤éŒ¯ç´€éŒ„
- [The Difference Between Clearing, Resetting, and Restoring Mocks](https://www.epicweb.dev/the-difference-between-clearing-resetting-and-restoring-mocks) â€” Epic Web Dev å°ä¸‰ç¨®æ¸…ç†æ–¹æ³•çš„è©³ç´°åœ–è§£èªªæ˜
- [Vitest Mock API å®˜æ–¹æ–‡ä»¶](https://vitest.dev/api/mock) â€” ç›´æ¥è®€æºé ­ï¼Œåˆ¥åªçœ‹æ•™å­¸æ–‡ç« 
- [Vitest 4.0 Release Blog](https://vitest.dev/blog/vitest-4) â€” Vitest 4 çš„å®Œæ•´ changelog å’Œ breaking changes
- [Jest issue #7136: clearAllMocks ä¸æ¸…é™¤å¯¦ä½œ](https://github.com/jestjs/jest/issues/7136) â€” 2018 å¹´å°±æœ‰äººæéçš„å•é¡Œï¼Œç†è§£è¨­è¨ˆæ­·å²çš„å¥½å…¥å£
- [Clearing Mocks in Vitest](https://www.farworldlabs.com/posts/clearing-mocks-in-vitest/) â€” å¦ä¸€å€‹è§’åº¦çš„å¯¦æˆ°å»ºè­°
